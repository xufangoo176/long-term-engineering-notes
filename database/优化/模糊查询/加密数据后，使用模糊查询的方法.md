# like 的模糊查询，无法查询被加密的数据

## 场景
总有一些数据，需要被加密后，才能存储到 DB。
但加密后的文本（专业术语“密文”），和原来的文本（专业术语“明文”），是牛马不相及的。
e.g. Xu Fan --加密后--> 645654655466565
当我通过 like 'Xu%' 去进行模糊查询，根本查不出来这行数据，因为 645654655466565 完全不存在 Xu 这个文本。

## 解决办法

### 解决办法1️⃣
（不推荐）先解密，再进行查询
具体是：先把尽可能符合条件的数据，全部查到内存中，然后在代码里面先解密，然后进行模糊查询。

优点：实现简单
缺点：在内存中处理数据，容易 OOM

### 解决办法2️⃣
（不推荐）明文映射表
具体是：有一张表，其中一个字段存储明文，还有一个字段存储对应密文的表的主键，但这种方式纯粹是扯淡。

### 解决办法3️⃣
（适合数据量不大，或者查询条件中还有其他查询字段可以走索引的情况）加密的时候如果用了函数的话，解密的时候我们也可以借助函数来做解密，同时做模糊查询，比如加密时使用了 AES_ENCRYPT 算法：
```sql
-- 加密数据
INSERT INTO user_data (username, credit_card) VALUES ('XuFan', AES_ENCRYPT('1234-5678-9012-3456', 'xufan_secret_key'));
```

那么在做模糊查询的时候就可以这样做：
```sql
SELECT * FROM user_data WHERE AES_DECRYPT(credit_card, 'xufan_secret_key') like 'Xu%';
```

缺点：
- 无法用到索引。不过不是因为用 like 失效，而是因为我们在字段上用了函数，索引就会失效。

### 解决办法4️⃣
明文分词
具体是：先把原文本进行分词，然后分别加密后存储到数据库中。
e.g.
1. XuFan 这个需要加密的字符串，我们把他拆成 Xu、XuF、Fan 等这几个字符串
2. 分别对他们进行加密，并保存到数据库中。

这样当我们使用 Xu、XuF、Fan 进行查询的时候，就可以对明文加密后去数据库中匹配了。

缺点:
- 第一个就是需要冗余很多字段 
- 第二个就是不够灵活，如果我按照 XuFa 来查询的话就不支持了。

当然，也有一些改进的方式，比如并不需要增加多个字段，可以把这些需要用于模糊查询的信息都放到同一个字段中，如 DECRYPT_NAME，拼接成一个字符串就行了。如71AAF3D8484F3160708C6A6D2D5F736B,83B01A578395CE81EAAAC6A4FE70AA94,E90848FB868AA98B7EC751CBD6DC78B7 这样就只需要通过这个字段做模糊查询就行了（索引也会失效）
SQL如下：
```sql
SELECT *
FROM hollis_test_table
WHERE DECRYPT_NAME REGEXP '71AAF3D8484F3160708C6A6D2D5F736B|83B01A578395CE81EAAAC6A4FE70AA94|E90848FB868AA98B7EC751CBD6DC78B7';
```

明文分词在很多大厂都在使用：
- 淘宝：https://open.taobao.com/docV3.htm?docId=106213&docType=1
- 拼多多：https://open.pinduoduo.com/application/document/browse?idStr=7553D76C8D1713EF




















