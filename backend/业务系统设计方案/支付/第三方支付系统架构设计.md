# 第三方支付系统架构设计



## 支付相关的专业名词

专业名词是必须要熟悉的，否则看各种技术文章和官方文档，脑子都是懵的。

| 专业名词 | 名词解释                                                     |
| -------- | ------------------------------------------------------------ |
| 支付工具 | 具有第三方支付能力的应用，如微信支付、支付宝都属于第三方支付工具。 |
| 用户     | 在支付工具中注册并开通和使用支付功能的人，就是该支付工具的用户。 |
| 商户     | 接入支付工具，对用户提供服务并收款的机构或个人。             |
| 用户账户 | 指第三方支付系统中为用户开具的账户，我们用 User Account 来代指，下文简称 U 账户。 |
| 商户账户 | 指第三方支付系统中为商户开具的账户，我们用 Merchant Account 来代指，下文简称 M 账户。 |
| 备付金   | 支付机构为办理客户委托的支付业务而实际收到的预收待付货币资金。可以简单理解为用户暂存在支付机构开具的银行账户中的资金。 |
| 系统资金 | 指第三方支付系统中登记的账户余额资金，本质上只是一个计算机系统数字记录，并不具备法定货币效力。 |
| 物理资金 | 指银行账户中存在的法定货币资金，可以近似认为是等同货币的真实物理资金。 |
| 支付     | 狭义的支付仅指用户向商户划转资金，广义的支付还包括充值、转账等功能。 |
| 付款     | 指资金从支付机构的备付金账户转出到目的银行账户。如用户将微信余额提现到自己的工行银行卡，此时资金从微信的工行备付金账户转账到用户的工行账户，这是付款的一种典型业务场景。 |
| 退款     | 指支付机构将用户支付的款项从商户账户退回到用户账户或银行卡的过程。 |
| 结算     | 是支付机构将商户账户中的资金，按照合同约定的时间和费率，收取手续费后转入商户的用户账户的过程。通常支付机构还会为商户提供自动提现到银行卡的附加功能。 |



## 支付的历史



### 第一方支付

“第一方”特指买卖双方直接以法定货币进行交易，即一手交钱一手交货，资金不通过任何中间机构。随着商业的发展，大宗交易不再适合使用现金进行支付，**第一方支付不再能满足需求。**



### 第二方支付

第二方支付是依托于银行的支付方式。买卖双方通过银行来进行资金的划转。



### 第三方支付

**微信支付**和**支付宝**都属于第三方支付工具。我们在自己的系统中基本就是要集成这些第三方支付，所以我们要重点关注第三方支付。

第三方支付是指具备一定实力和信誉保障，并获得国家颁发运营牌照的独立机构，采用和各大银行签约的方式，通过与银行相关接口对接而促成交易的网络支付模式。



### 第四方支付

第四方支付实际上是聚合了多个第三方支付、合作银行的渠道接口，为商户提供一站式的支付解决方案。第四方支付的优势在将多家第三方支付聚合在一起，给商户提供了一站式的支付解决方案，同时便利了商户和用户。但第四方支付目前缺乏政策资质，存在较大的**资金安全风险**。





## 第三方支付概述

涉及到了 4 个角色：用户、商户、银行以及第三方支付工具本身。由此可见，第三方支付系统必须至少在内部抽象出 3 种角色来为用户、商户和银行服务。由于支付主要涉及到的是资金的记录和流转，适合以账户形式承载，因此延伸至第三方支付系统中的 **3 种账户。**



### 三种账户

账户是支付机构内部为其服务对象（用户、商户、银行等）创建的物理记录（类似于表格），这些记录包含了对象的关键信息，如机构为对象分配的唯一 ID、对象的余额、交易的流水、账户状态等等。可以说账户是支付机构识别服务对象的根本，所有服务对象都必须要有账户。

根据第三方支付的服务对象，我们将抽象出三种账户：

1. 用户账户（User Account）
2. 商户账户（Merchant Account）
3. 银行账户（Bank Account）



但 3 个服务对象和  3 种账户并不是 1 对 1 的，而是：

用户 -> 用户账户

商户 -> 用户账户 & 商户账户

银行 -> 银行账户



用户只拥有用户账户就足够了，而商户则往往同时拥有商户账户和用户账户，银行则只对应于银行账户。

**为什么商户还额外拥有用户账户呢？**这是出于资金管理的需要。商户账户中的资金并非全部归属于商户本身，其中有一部分是第三方支付机构将会收取商户的佣金。只有在支付机构收完佣金后的净额才归属于商户本身，才能任其自由使用。

简而言之，商户账户中的资金商户无法直接动用，需要在支付机构收取完佣金后结转到商户的用户账户中才能自由提取。这其实就是结算过程，后续结算卷我会有专门的文章讲解，此处仅做简单了解即可。



#### 用户账户（User Account）

一个用户的账户需要记录什么信息呢？需要有一个唯一的账户 ID 避免记录混乱，需要为用户记录余额，需要记录账户的资金变动过程（流水）。

用户账户的行为特点：

1. 很少并发：同一时刻通常只会发生一笔交易，因为支付需要用户手动去操作。
2. 交易频率较低：一个普通用户通常一天只会支付数笔。
3. 余额敏感：用户对自己的账户余额及其变动非常敏感。



#### 商户账户（Merchant Account）

商户账户需要记录的最基础信息同用户一样，也是 ID、余额和流水。

商户账户的行为特点：

1. 高并发：同一时刻会有很多用户向同一个商户支付，促销活动时更甚。
2. 交易频率高：一个商户一天的交易可能会非常大。
3. 余额变动不敏感：由于商户伴随着用户的不断支付，余额会快速变化，因此商户本身对该账户余额不敏感。



#### 银行账户（Bank Account）

银行账户的特点：

1. 数量有限：银行账户映射的是各大银行，因此数量有限。
2. 金额流水庞大：一个大型支付机构和银行的资金交易往来通常都是以亿为单位，金额特别庞大。
3. 并发量高：拥有同一银行卡的用户非常多，这些用户同时使用银行卡支付、体现的量级也非常大，其量级比单个商户会大很多。
4. 余额不敏感：因为是支付机构内部为了映射银行而开具的内部账户，银行并不会关注，所以除了支付机构本身，没人会关注该账户余额。



### 运作模式

支付机构本质上还是资金相关的操作，我们知道第三方支付涉及用户、银行和支付机构本身。接下来让我们尝试用上文的账户体系来分析一下常见的支付过程。



#### 初始状态

我们将以一个典型例子来说明

![image-20260117223555250](/Users/xufan/workspace/long-term-engineering-notes/backend/business-systems/支付/image/image-20260117223555250.png)



涉及的用户有两个，张三和李四，他们分别有自己的微信账户和银行账户，微信也在银行开具了自己的银行账户，称为备付金账户（专业名词章节介绍）。他们各自的余额如上图所示。



#### 用户充值

现在假设张三想要通过自己的银行卡充值 20 元到微信余额，资金变动如下图所示：

![image-20260117223637358](/Users/xufan/workspace/long-term-engineering-notes/backend/business-systems/支付/image/image-20260117223637358.png)



首先是张三的银行账户向微信备付金账户划扣 20 元，成功后微信则给张三的微信余额加 20 元，充值完成。

PS：用户在微信中绑定了银行卡，因此不需要用户去银行转账，而是通过微信与银行间的接口来自动完成该笔资金的划扣。



#### 用户提现

假设李四想要将微信中余额提现 10 元到自己的银行卡，则资金变动如下：

![image-20260117223711460](/Users/xufan/workspace/long-term-engineering-notes/backend/business-systems/支付/image/image-20260117223711460.png)

首先将李四的微信余额减去 10 元，然后微信支付调用银行接口，从微信备付金账户中转账 10 元到李四的银行卡中，提现过程结束。

PS：这里减去李四微信余额时并不是直接减掉，而是先冻结，等银行侧成功转账后再实际减去。冻结和解冻的细节和原因将在付款卷中详细介绍。



#### 用户转账

假设张三要给李四转账 20 元，则资金变动如下图：

![image-20260117223748304](/Users/xufan/workspace/long-term-engineering-notes/backend/business-systems/支付/image/image-20260117223748304.png)



此时，张三的余额先减 20，然后李四的余额加 20，转账完成。

PS：微信转账有确认收款的过程，如果我们要用上述账户体系来完成这个功能，可以怎么做呢？这个问题将会在未来中探讨。



#### 资金变动汇总

![image-20260117223825564](/Users/xufan/workspace/long-term-engineering-notes/backend/business-systems/支付/image/image-20260117223825564.png)

从上面的表格我们注意到：备付金账户和微信账户的变动净额总是相等的。

1. 在充值时，微信体系余额增加，则备付金账户也会增加相同的金额；
2. 提现时，微信体系余额减少，则备付金账户的余额也会减少相同金额。
3. 转账时，只是支付工具内部账户之前的划转，不涉及资金流入和流入支付体系，因此备付金账户余额不变。

因此，我们可以认为**所有支付系统余额是所有备付金银行账户余额的映射。**我们称微信余额为系统资金，银行余额为物理资金。如果物理资金小于系统资金，则说明物理资金被挪用，可能会导致用户无法提现。国家会监管持牌支付机构的备付金使用情况，避免这样的情况出现。



### 支付交互

商户账户的支付过程如下图所示：![image-20260117223903280](/Users/xufan/workspace/long-term-engineering-notes/backend/business-systems/支付/image/image-20260117223903280.png)

用户和商户也都拥有自己的银行账户和微信支付账户。微信支付作为中间桥梁，将银行、用户、商户连接起来，共同构成了整个交易网络。 从交互图中可以看出，支付系统具有很多重要的功能：

1. 充值：用户将银行卡中的资金转移微信支付中，成为微信余额的过程。
2. 提现：用户或商户将微信余额转移到银行卡的过程。
3. 支付：这里特指用户将资金从自己的现金账户划转到商户的交易账户过程。
4. 退款：支付的逆向过程，将资金从商户账户退回到用户账户。
5. 结算：用户支付给商户的资金，在收取手续费后，划转到商户的现金账户的过程。

上述功能中，有的只涉及用户，如充值和提现；有的同时涉及用户和商户，如支付、退款；而有的只涉及商户，如结算。



### 领域拆分

让我们对上面的各种交易类型做一个整合，在业务领域上进行拆分和归纳，如下图所示：

![image-20260117223940739](/Users/xufan/workspace/long-term-engineering-notes/backend/business-systems/支付/image/image-20260117223940739.png)

下面对这些领域及其职责进行简单说明：

1. 支付（广义）：负责支付、转账、充值等基础交易能力的提供。
2. 退款：负责将用户支付的资金从商户账户退回用户账户或用户银行卡。
3. 付款：负责将支付体系内的资金提取到指定的用户银行账户，即提现。
4. 结算：负责按照合同约定的规则，将商户交易账户的资金划转到商户现金账户，并收取交易手续费。

各个领域提供基础能力，并服务各种各样的业务场景。有的业务场景需要多种领域能力合作完成，如结算业务需要依赖于付款的提现能力。

















